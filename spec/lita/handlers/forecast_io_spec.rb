require_relative '../../spec_helper'

describe Lita::Handlers::ForecastIo, lita_handler: true do
  # it { is_expected.to route("some message") }
  # it 'lets everyone know when someone is happy' do
  #   send_message("I'm happy!")
  #   expect(replies.last).to eq("Hey, everyone! #{user.name} is happy! Isn't that nice?")
  # end
  before(:each) do
    mock_geocoder = ::Geocoder::Result::Google.new({'formatted_address' => 'Portland, OR', 'geometry' => { 'location' => { 'lat' => 45.523452, 'lng' => -122.676207 }}})
    allow(::Geocoder).to receive(:search) { [mock_geocoder] }  # It expects an array of geocoder objects.

    # Mock up the ForecastAPI call.
    # Todo: add some other mocks to allow more edgy testing (rain percentages, !rain eightball replies, etc
    allow(RestClient).to receive(:get) { '{"latitude":45.523452,"longitude":-122.676207,"timezone":"America/Los_Angeles","offset":-8,"currently":{"time":1417361745,"summary":"Clear","icon":"clear-day","nearestStormDistance":158,"nearestStormBearing":179,"precipIntensity":0,"precipProbability":0,"temperature":28.39,"apparentTemperature":22.15,"dewPoint":17.88,"humidity":0.64,"windSpeed":5.74,"windBearing":78,"visibility":10,"cloudCover":0,"pressure":1021.17,"ozone":357.71},"minutely":{"summary":"Clear for the hour.","icon":"clear-day","data":[{"time":1417361700,"precipIntensity":0,"precipProbability":0},{"time":1417361760,"precipIntensity":0.1,"precipProbability":0.1},{"time":1417361820,"precipIntensity":0.2,"precipProbability":0.2},{"time":1417361880,"precipIntensity":0,"precipProbability":0.3},{"time":1417361940,"precipIntensity":0,"precipProbability":0.4},{"time":1417362000,"precipIntensity":0,"precipProbability":0.5},{"time":1417362060,"precipIntensity":0,"precipProbability":0.6},{"time":1417362120,"precipIntensity":0,"precipProbability":0.7},{"time":1417362180,"precipIntensity":0,"precipProbability":0.8},{"time":1417362240,"precipIntensity":0,"precipProbability":0.9},{"time":1417362300,"precipIntensity":0,"precipProbability":1},{"time":1417362360,"precipIntensity":0,"precipProbability":0},{"time":1417362420,"precipIntensity":0,"precipProbability":0},{"time":1417362480,"precipIntensity":0,"precipProbability":0},{"time":1417362540,"precipIntensity":0,"precipProbability":0},{"time":1417362600,"precipIntensity":0,"precipProbability":0},{"time":1417362660,"precipIntensity":0,"precipProbability":0},{"time":1417362720,"precipIntensity":0,"precipProbability":0},{"time":1417362780,"precipIntensity":0,"precipProbability":0},{"time":1417362840,"precipIntensity":0,"precipProbability":0},{"time":1417362900,"precipIntensity":0,"precipProbability":0},{"time":1417362960,"precipIntensity":0,"precipProbability":0},{"time":1417363020,"precipIntensity":0,"precipProbability":0},{"time":1417363080,"precipIntensity":0,"precipProbability":0},{"time":1417363140,"precipIntensity":0,"precipProbability":0},{"time":1417363200,"precipIntensity":0,"precipProbability":0},{"time":1417363260,"precipIntensity":0,"precipProbability":0},{"time":1417363320,"precipIntensity":0,"precipProbability":0},{"time":1417363380,"precipIntensity":0,"precipProbability":0},{"time":1417363440,"precipIntensity":0,"precipProbability":0},{"time":1417363500,"precipIntensity":0,"precipProbability":0},{"time":1417363560,"precipIntensity":0,"precipProbability":0},{"time":1417363620,"precipIntensity":0,"precipProbability":0},{"time":1417363680,"precipIntensity":0,"precipProbability":0},{"time":1417363740,"precipIntensity":0,"precipProbability":0},{"time":1417363800,"precipIntensity":0,"precipProbability":0},{"time":1417363860,"precipIntensity":0,"precipProbability":0},{"time":1417363920,"precipIntensity":0,"precipProbability":0},{"time":1417363980,"precipIntensity":0,"precipProbability":0},{"time":1417364040,"precipIntensity":0,"precipProbability":0},{"time":1417364100,"precipIntensity":0,"precipProbability":0},{"time":1417364160,"precipIntensity":0,"precipProbability":0},{"time":1417364220,"precipIntensity":0,"precipProbability":0},{"time":1417364280,"precipIntensity":0,"precipProbability":0},{"time":1417364340,"precipIntensity":0,"precipProbability":0},{"time":1417364400,"precipIntensity":0,"precipProbability":0},{"time":1417364460,"precipIntensity":0,"precipProbability":0},{"time":1417364520,"precipIntensity":0,"precipProbability":0},{"time":1417364580,"precipIntensity":0,"precipProbability":0},{"time":1417364640,"precipIntensity":0,"precipProbability":0},{"time":1417364700,"precipIntensity":0,"precipProbability":0},{"time":1417364760,"precipIntensity":0,"precipProbability":0},{"time":1417364820,"precipIntensity":0,"precipProbability":0},{"time":1417364880,"precipIntensity":0,"precipProbability":0},{"time":1417364940,"precipIntensity":0,"precipProbability":0},{"time":1417365000,"precipIntensity":0,"precipProbability":0},{"time":1417365060,"precipIntensity":0,"precipProbability":0},{"time":1417365120,"precipIntensity":0,"precipProbability":0},{"time":1417365180,"precipIntensity":0,"precipProbability":0},{"time":1417365240,"precipIntensity":0,"precipProbability":0},{"time":1417365300,"precipIntensity":0,"precipProbability":0}]},"hourly":{"summary":"Flurries tomorrow morning.","icon":"snow","data":[{"time":1417359600,"summary":"Clear","icon":"clear-night","precipIntensity":0,"precipProbability":0,"temperature":28.3,"apparentTemperature":23.46,"dewPoint":18.62,"humidity":0.67,"windSpeed":4.3,"windBearing":81,"visibility":10,"cloudCover":0,"pressure":1021.2,"ozone":357.98},{"time":1417363200,"summary":"Clear","icon":"clear-day","precipIntensity":0,"precipProbability":0,"temperature":28.45,"apparentTemperature":21.42,"dewPoint":17.36,"humidity":0.63,"windSpeed":6.73,"windBearing":77,"visibility":10,"cloudCover":0,"pressure":1021.15,"ozone":357.52},{"time":1417366800,"summary":"Clear","icon":"clear-day","precipIntensity":0,"precipProbability":0,"temperature":30.23,"apparentTemperature":22.86,"dewPoint":17.01,"humidity":0.57,"windSpeed":7.74,"windBearing":78,"visibility":10,"cloudCover":0,"pressure":1020.97,"ozone":357.13},{"time":1417370400,"summary":"Clear","icon":"clear-day","precipIntensity":0,"precipProbability":0,"temperature":32.51,"apparentTemperature":24.79,"dewPoint":16.68,"humidity":0.52,"windSpeed":9.19,"windBearing":82,"visibility":10,"cloudCover":0,"pressure":1020.68,"ozone":356.83},{"time":1417374000,"summary":"Clear","icon":"clear-day","precipIntensity":0,"precipProbability":0,"temperature":34.79,"apparentTemperature":26.55,"dewPoint":16.65,"humidity":0.47,"windSpeed":11.37,"windBearing":86,"visibility":10,"cloudCover":0,"pressure":1020.2,"ozone":356.87},{"time":1417377600,"summary":"Clear","icon":"clear-day","precipIntensity":0,"precipProbability":0,"temperature":36.54,"apparentTemperature":28.52,"dewPoint":16.53,"humidity":0.44,"windSpeed":11.94,"windBearing":87,"visibility":10,"cloudCover":0,"pressure":1019.58,"ozone":357.01},{"time":1417381200,"summary":"Clear","icon":"clear-day","precipIntensity":0,"precipProbability":0,"temperature":38.72,"apparentTemperature":30.97,"dewPoint":17.17,"humidity":0.41,"windSpeed":12.71,"windBearing":88,"visibility":10,"cloudCover":0,"pressure":1019.03,"ozone":356.5},{"time":1417384800,"summary":"Clear","icon":"clear-day","precipIntensity":0,"precipProbability":0,"temperature":38.99,"apparentTemperature":31.45,"dewPoint":17.38,"humidity":0.41,"windSpeed":12.35,"windBearing":87,"visibility":10,"cloudCover":0,"pressure":1018.67,"ozone":354.67},{"time":1417388400,"summary":"Clear","icon":"clear-day","precipIntensity":0,"precipProbability":0,"temperature":37.95,"apparentTemperature":30.41,"dewPoint":17.18,"humidity":0.42,"windSpeed":11.63,"windBearing":83,"visibility":10,"cloudCover":0,"pressure":1018.44,"ozone":352.19},{"time":1417392000,"summary":"Clear","icon":"clear-day","precipIntensity":0,"precipProbability":0,"temperature":36.56,"apparentTemperature":28.96,"dewPoint":16.86,"humidity":0.44,"windSpeed":10.93,"windBearing":83,"visibility":10,"cloudCover":0,"pressure":1018.42,"ozone":350.33},{"time":1417395600,"summary":"Clear","icon":"clear-night","precipIntensity":0,"precipProbability":0,"temperature":34.59,"apparentTemperature":26.7,"dewPoint":15.91,"humidity":0.46,"windSpeed":10.5,"windBearing":85,"visibility":10,"cloudCover":0,"pressure":1018.73,"ozone":349.53},{"time":1417399200,"summary":"Clear","icon":"clear-night","precipIntensity":0,"precipProbability":0,"temperature":32.8,"apparentTemperature":24.6,"dewPoint":14.8,"humidity":0.47,"windSpeed":10.23,"windBearing":87,"visibility":10,"cloudCover":0.01,"pressure":1019.24,"ozone":349.36},{"time":1417402800,"summary":"Clear","icon":"clear-night","precipIntensity":0,"precipProbability":0,"temperature":31.59,"apparentTemperature":23.21,"dewPoint":14.27,"humidity":0.48,"windSpeed":10.01,"windBearing":90,"visibility":10,"cloudCover":0.01,"pressure":1019.63,"ozone":349.82},{"time":1417406400,"summary":"Clear","icon":"clear-night","precipIntensity":0,"precipProbability":0,"temperature":30.8,"apparentTemperature":22.39,"dewPoint":14.09,"humidity":0.49,"windSpeed":9.72,"windBearing":91,"visibility":10,"cloudCover":0.01,"pressure":1019.78,"ozone":351.06},{"time":1417410000,"summary":"Clear","icon":"clear-night","precipIntensity":0,"precipProbability":0,"temperature":30.63,"apparentTemperature":22.45,"dewPoint":14.54,"humidity":0.51,"windSpeed":9.22,"windBearing":90,"visibility":10,"cloudCover":0.01,"pressure":1019.81,"ozone":352.93},{"time":1417413600,"summary":"Clear","icon":"clear-night","precipIntensity":0,"precipProbability":0,"temperature":30.48,"apparentTemperature":22.55,"dewPoint":14.97,"humidity":0.52,"windSpeed":8.73,"windBearing":90,"visibility":10,"cloudCover":0.02,"pressure":1019.78,"ozone":354.99},{"time":1417417200,"summary":"Clear","icon":"clear-night","precipIntensity":0,"precipProbability":0,"temperature":30.22,"apparentTemperature":22.73,"dewPoint":15.41,"humidity":0.54,"windSpeed":7.91,"windBearing":89,"visibility":10,"cloudCover":0.03,"pressure":1019.66,"ozone":357.65},{"time":1417420800,"summary":"Clear","icon":"clear-night","precipIntensity":0,"precipProbability":0,"temperature":29.94,"apparentTemperature":22.73,"dewPoint":16.03,"humidity":0.56,"windSpeed":7.41,"windBearing":89,"visibility":10,"cloudCover":0.06,"pressure":1019.48,"ozone":360.5},{"time":1417424400,"summary":"Clear","icon":"clear-night","precipIntensity":0,"precipProbability":0,"temperature":29.41,"apparentTemperature":22.2,"dewPoint":16.32,"humidity":0.58,"windSpeed":7.24,"windBearing":86,"visibility":10,"cloudCover":0.1,"pressure":1019.31,"ozone":361.88},{"time":1417428000,"summary":"Clear","icon":"clear-night","precipIntensity":0,"precipProbability":0,"temperature":29.22,"apparentTemperature":22.14,"dewPoint":16.99,"humidity":0.6,"windSpeed":7,"windBearing":83,"visibility":10,"cloudCover":0.2,"pressure":1019.16,"ozone":361.01},{"time":1417431600,"summary":"Partly Cloudy","icon":"partly-cloudy-night","precipIntensity":0,"precipProbability":0,"temperature":29.29,"apparentTemperature":22.48,"dewPoint":17.9,"humidity":0.62,"windSpeed":6.67,"windBearing":79,"visibility":10,"cloudCover":0.33,"pressure":1019.03,"ozone":358.66},{"time":1417435200,"summary":"Partly Cloudy","icon":"partly-cloudy-night","precipIntensity":0,"precipProbability":0,"temperature":28.86,"apparentTemperature":22.31,"dewPoint":18.15,"humidity":0.64,"windSpeed":6.22,"windBearing":76,"visibility":10,"cloudCover":0.43,"pressure":1018.92,"ozone":355.42},{"time":1417438800,"summary":"Partly Cloudy","icon":"partly-cloudy-night","precipIntensity":0,"precipProbability":0,"temperature":28.44,"apparentTemperature":22.34,"dewPoint":18.26,"humidity":0.65,"windSpeed":5.6,"windBearing":74,"visibility":10,"cloudCover":0.49,"pressure":1018.76,"ozone":350.78},{"time":1417442400,"summary":"Flurries","icon":"snow","precipIntensity":0.0018,"precipProbability":0.01,"precipType":"snow","precipAccumulation":0.017636097742098344,"temperature":28.5,"apparentTemperature":22.99,"dewPoint":18.51,"humidity":0.66,"windSpeed":4.97,"windBearing":72,"visibility":10,"cloudCover":0.55,"pressure":1018.56,"ozone":345.25},{"time":1417446000,"summary":"Flurries","icon":"snow","precipIntensity":0.0026,"precipProbability":0.03,"precipType":"snow","precipAccumulation":0.02451729314873083,"temperature":29.08,"apparentTemperature":24.14,"dewPoint":19.17,"humidity":0.66,"windSpeed":4.51,"windBearing":71,"visibility":10,"cloudCover":0.61,"pressure":1018.51,"ozone":340.85},{"time":1417449600,"summary":"Light Snow","icon":"snow","precipIntensity":0.0031,"precipProbability":0.04,"precipType":"snow","precipAccumulation":0.02622178965010701,"temperature":30.64,"apparentTemperature":26.31,"dewPoint":20.66,"humidity":0.66,"windSpeed":4.17,"windBearing":71,"visibility":10,"cloudCover":0.75,"pressure":1018.73,"ozone":338.41},{"time":1417453200,"summary":"Light Snow","icon":"snow","precipIntensity":0.0035,"precipProbability":0.04,"precipType":"snow","precipAccumulation":0.0266,"temperature":32.55,"apparentTemperature":29.21,"dewPoint":22.4,"humidity":0.66,"windSpeed":3.57,"windBearing":71,"visibility":10,"cloudCover":0.84,"pressure":1019.12,"ozone":337.1},{"time":1417456800,"summary":"Mostly Cloudy","icon":"partly-cloudy-day","precipIntensity":0.0036,"precipProbability":0.04,"precipType":"rain","temperature":34.38,"apparentTemperature":34.38,"dewPoint":24.1,"humidity":0.66,"windSpeed":2.87,"windBearing":69,"visibility":10,"cloudCover":0.88,"pressure":1019.32,"ozone":336.56},{"time":1417460400,"summary":"Mostly Cloudy","icon":"partly-cloudy-day","precipIntensity":0.0034,"precipProbability":0.04,"precipType":"rain","temperature":36.2,"apparentTemperature":36.2,"dewPoint":25.77,"humidity":0.65,"windSpeed":2.45,"windBearing":68,"visibility":10,"cloudCover":0.84,"pressure":1019.09,"ozone":336.99},{"time":1417464000,"summary":"Mostly Cloudy","icon":"partly-cloudy-day","precipIntensity":0.0029,"precipProbability":0.03,"precipType":"rain","temperature":40.07,"apparentTemperature":40.07,"dewPoint":29.44,"humidity":0.65,"windSpeed":2.09,"windBearing":66,"visibility":10,"cloudCover":0.78,"pressure":1018.63,"ozone":338.2},{"time":1417467600,"summary":"Mostly Cloudy","icon":"partly-cloudy-day","precipIntensity":0.0026,"precipProbability":0.02,"precipType":"rain","temperature":41.32,"apparentTemperature":41.32,"dewPoint":31.01,"humidity":0.66,"windSpeed":1.78,"windBearing":61,"visibility":10,"cloudCover":0.73,"pressure":1018.25,"ozone":339.24},{"time":1417471200,"summary":"Mostly Cloudy","icon":"partly-cloudy-day","precipIntensity":0.0025,"precipProbability":0.02,"precipType":"rain","temperature":41.18,"apparentTemperature":41.18,"dewPoint":31.97,"humidity":0.69,"windSpeed":1.53,"windBearing":52,"visibility":10,"cloudCover":0.75,"pressure":1018.07,"ozone":339.9},{"time":1417474800,"summary":"Mostly Cloudy","icon":"partly-cloudy-day","precipIntensity":0.0026,"precipProbability":0.02,"precipType":"rain","temperature":39.7,"apparentTemperature":39.7,"dewPoint":31.95,"humidity":0.74,"windSpeed":1.39,"windBearing":41,"visibility":10,"cloudCover":0.83,"pressure":1017.99,"ozone":340.4},{"time":1417478400,"summary":"Mostly Cloudy","icon":"partly-cloudy-day","precipIntensity":0.0027,"precipProbability":0.02,"precipType":"rain","temperature":38.78,"apparentTemperature":38.78,"dewPoint":32.24,"humidity":0.77,"windSpeed":1.47,"windBearing":29,"visibility":10,"cloudCover":0.87,"pressure":1017.96,"ozone":340.49},{"time":1417482000,"summary":"Mostly Cloudy","icon":"partly-cloudy-night","precipIntensity":0.0028,"precipProbability":0.02,"precipType":"rain","temperature":38.06,"apparentTemperature":38.06,"dewPoint":32.33,"humidity":0.8,"windSpeed":1.84,"windBearing":23,"visibility":10,"cloudCover":0.87,"pressure":1017.96,"ozone":340.05},{"time":1417485600,"summary":"Mostly Cloudy","icon":"partly-cloudy-night","precipIntensity":0.0028,"precipProbability":0.02,"precipType":"rain","temperature":37.19,"apparentTemperature":37.19,"dewPoint":32.11,"humidity":0.82,"windSpeed":2.37,"windBearing":21,"visibility":10,"cloudCover":0.84,"pressure":1018.01,"ozone":339.2},{"time":1417489200,"summary":"Mostly Cloudy","icon":"partly-cloudy-night","precipIntensity":0.0029,"precipProbability":0.02,"precipType":"rain","temperature":36.16,"apparentTemperature":36.16,"dewPoint":31.56,"humidity":0.83,"windSpeed":2.82,"windBearing":19,"visibility":10,"cloudCover":0.79,"pressure":1018.12,"ozone":338.07},{"time":1417492800,"summary":"Mostly Cloudy","icon":"partly-cloudy-night","precipIntensity":0.003,"precipProbability":0.02,"precipType":"rain","temperature":35.03,"apparentTemperature":32.57,"dewPoint":30.72,"humidity":0.84,"windSpeed":3.13,"windBearing":16,"visibility":10,"cloudCover":0.66,"pressure":1018.32,"ozone":336.55},{"time":1417496400,"summary":"Partly Cloudy","icon":"partly-cloudy-night","precipIntensity":0.003,"precipProbability":0.02,"precipType":"rain","temperature":34.13,"apparentTemperature":31.15,"dewPoint":29.96,"humidity":0.84,"windSpeed":3.45,"windBearing":14,"visibility":10,"cloudCover":0.51,"pressure":1018.58,"ozone":334.74},{"time":1417500000,"summary":"Partly Cloudy","icon":"partly-cloudy-night","precipIntensity":0.003,"precipProbability":0.02,"precipType":"rain","temperature":33.44,"apparentTemperature":30.24,"dewPoint":29.35,"humidity":0.85,"windSpeed":3.56,"windBearing":13,"visibility":10,"cloudCover":0.42,"pressure":1018.78,"ozone":333.12},{"time":1417503600,"summary":"Flurries","icon":"snow","precipIntensity":0.0029,"precipProbability":0.02,"precipType":"snow","precipAccumulation":0.022039999999999997,"temperature":32.91,"apparentTemperature":29.78,"dewPoint":28.88,"humidity":0.85,"windSpeed":3.44,"windBearing":14,"visibility":10,"cloudCover":0.37,"pressure":1018.94,"ozone":331.87},{"time":1417507200,"summary":"Flurries","icon":"snow","precipIntensity":0.0027,"precipProbability":0.02,"precipType":"snow","precipAccumulation":0.02052,"temperature":32.42,"apparentTemperature":29.54,"dewPoint":28.4,"humidity":0.85,"windSpeed":3.19,"windBearing":14,"visibility":10,"cloudCover":0.33,"pressure":1019.06,"ozone":330.81},{"time":1417510800,"summary":"Flurries","icon":"snow","precipIntensity":0.0025,"precipProbability":0.02,"precipType":"snow","precipAccumulation":0.01916140182525712,"temperature":31.95,"apparentTemperature":29.14,"dewPoint":27.9,"humidity":0.85,"windSpeed":3.09,"windBearing":17,"visibility":10,"cloudCover":0.3,"pressure":1019.08,"ozone":329.79},{"time":1417514400,"summary":"Flurries","icon":"snow","precipIntensity":0.0022,"precipProbability":0.01,"precipType":"snow","precipAccumulation":0.01763020738625114,"temperature":31.37,"apparentTemperature":28.27,"dewPoint":27.26,"humidity":0.85,"windSpeed":3.25,"windBearing":19,"visibility":10,"cloudCover":0.28,"pressure":1018.9,"ozone":328.54},{"time":1417518000,"summary":"Flurries","icon":"snow","precipIntensity":0.002,"precipProbability":0.01,"precipType":"snow","precipAccumulation":0.016684519011263443,"temperature":30.83,"apparentTemperature":27.25,"dewPoint":26.62,"humidity":0.84,"windSpeed":3.56,"windBearing":22,"visibility":10,"cloudCover":0.26,"pressure":1018.56,"ozone":327.32},{"time":1417521600,"summary":"Flurries","icon":"snow","precipIntensity":0.0017,"precipProbability":0.01,"precipType":"snow","precipAccumulation":0.014410994373598785,"temperature":30.61,"apparentTemperature":26.59,"dewPoint":26.24,"humidity":0.84,"windSpeed":3.9,"windBearing":26,"visibility":10,"cloudCover":0.26,"pressure":1018.25,"ozone":326.84},{"time":1417525200,"summary":"Partly Cloudy","icon":"partly-cloudy-night","precipIntensity":0.0015,"precipProbability":0.01,"precipType":"snow","precipAccumulation":0.012863152140267911,"temperature":30.45,"apparentTemperature":26.09,"dewPoint":25.92,"humidity":0.83,"windSpeed":4.18,"windBearing":29,"visibility":10,"cloudCover":0.25,"pressure":1018.21,"ozone":327.55},{"time":1417528800,"summary":"Partly Cloudy","icon":"partly-cloudy-night","precipIntensity":0.0013,"precipProbability":0.01,"precipType":"snow","precipAccumulation":0.011164078432158692,"temperature":30.43,"apparentTemperature":25.76,"dewPoint":25.67,"humidity":0.82,"windSpeed":4.46,"windBearing":34,"visibility":10,"cloudCover":0.25,"pressure":1018.28,"ozone":328.99},{"time":1417532400,"summary":"Clear","icon":"clear-night","precipIntensity":0,"precipProbability":0,"temperature":31.24,"apparentTemperature":26.33,"dewPoint":25.94,"humidity":0.8,"windSpeed":4.85,"windBearing":40,"visibility":10,"cloudCover":0.23,"pressure":1018.31,"ozone":330.44}]},"daily":{"summary":"Mixed precipitation tomorrow through Sunday, with temperatures rising to 52°F on Sunday.","icon":"rain","data":[{"time":1417334400,"summary":"Clear throughout the day.","icon":"clear-day","sunriseTime":1417361458,"sunsetTime":1417393855,"moonPhase":0.3,"precipIntensity":0,"precipIntensityMax":0,"precipProbability":0,"temperatureMin":28.17,"temperatureMinTime":1417345200,"temperatureMax":38.99,"temperatureMaxTime":1417384800,"apparentTemperatureMin":21.42,"apparentTemperatureMinTime":1417363200,"apparentTemperatureMax":31.45,"apparentTemperatureMaxTime":1417384800,"dewPoint":18.26,"humidity":0.58,"windSpeed":7.67,"windBearing":82,"visibility":9.9,"cloudCover":0.02,"pressure":1019.92,"ozone":355.91},{"time":1417420800,"summary":"Light snow in the morning and overnight.","icon":"snow","sunriseTime":1417447928,"sunsetTime":1417480229,"moonPhase":0.34,"precipIntensity":0.0022,"precipIntensityMax":0.0036,"precipIntensityMaxTime":1417456800,"precipProbability":0.04,"precipType":"snow","precipAccumulation":0.417,"temperatureMin":28.44,"temperatureMinTime":1417438800,"temperatureMax":41.32,"temperatureMaxTime":1417467600,"apparentTemperatureMin":22.14,"apparentTemperatureMinTime":1417428000,"apparentTemperatureMax":41.32,"apparentTemperatureMaxTime":1417467600,"dewPoint":25.24,"humidity":0.71,"windSpeed":3.42,"windBearing":62,"visibility":10,"cloudCover":0.6,"pressure":1018.65,"ozone":343.14},{"time":1417507200,"summary":"Partly cloudy starting in the evening.","icon":"partly-cloudy-night","sunriseTime":1417534397,"sunsetTime":1417566606,"moonPhase":0.38,"precipIntensity":0.0008,"precipIntensityMax":0.0027,"precipIntensityMaxTime":1417507200,"precipProbability":0.02,"precipType":"snow","precipAccumulation":0.146,"temperatureMin":30.43,"temperatureMinTime":1417528800,"temperatureMax":45.5,"temperatureMaxTime":1417554000,"apparentTemperatureMin":25.76,"apparentTemperatureMinTime":1417528800,"apparentTemperatureMax":40.76,"apparentTemperatureMaxTime":1417554000,"dewPoint":28.4,"humidity":0.73,"windSpeed":6.85,"windBearing":61,"visibility":10,"cloudCover":0.21,"pressure":1016.48,"ozone":333.32},{"time":1417593600,"summary":"Light rain overnight.","icon":"rain","sunriseTime":1417620864,"sunsetTime":1417652985,"moonPhase":0.41,"precipIntensity":0.0007,"precipIntensityMax":0.0044,"precipIntensityMaxTime":1417676400,"precipProbability":0.14,"precipType":"rain","temperatureMin":33.97,"temperatureMinTime":1417611600,"temperatureMax":44.67,"temperatureMaxTime":1417640400,"apparentTemperatureMin":27.04,"apparentTemperatureMinTime":1417593600,"apparentTemperatureMax":40.92,"apparentTemperatureMaxTime":1417640400,"dewPoint":29.68,"humidity":0.7,"windSpeed":6.94,"windBearing":83,"visibility":10,"cloudCover":0.73,"pressure":1013.45,"ozone":328.64},{"time":1417680000,"summary":"Light rain throughout the day.","icon":"rain","sunriseTime":1417707330,"sunsetTime":1417739367,"moonPhase":0.45,"precipIntensity":0.0131,"precipIntensityMax":0.0209,"precipIntensityMaxTime":1417705200,"precipProbability":1,"precipType":"rain","temperatureMin":39.41,"temperatureMinTime":1417694400,"temperatureMax":45.53,"temperatureMaxTime":1417726800,"apparentTemperatureMin":36.33,"apparentTemperatureMinTime":1417680000,"apparentTemperatureMax":45.53,"apparentTemperatureMaxTime":1417726800,"dewPoint":39.95,"humidity":0.93,"windSpeed":2.73,"windBearing":114,"cloudCover":0.76,"pressure":1014.17,"ozone":322.66},{"time":1417766400,"summary":"Drizzle until evening, starting again overnight.","icon":"rain","sunriseTime":1417793794,"sunsetTime":1417825752,"moonPhase":0.48,"precipIntensity":0.0053,"precipIntensityMax":0.008,"precipIntensityMaxTime":1417766400,"precipProbability":0.4,"precipType":"rain","temperatureMin":37.76,"temperatureMinTime":1417788000,"temperatureMax":49.43,"temperatureMaxTime":1417813200,"apparentTemperatureMin":36.73,"apparentTemperatureMinTime":1417791600,"apparentTemperatureMax":49.43,"apparentTemperatureMaxTime":1417813200,"dewPoint":41.28,"humidity":0.93,"windSpeed":2.77,"windBearing":148,"cloudCover":0.42,"pressure":1020.74,"ozone":320.13},{"time":1417852800,"summary":"Drizzle in the morning.","icon":"rain","sunriseTime":1417880256,"sunsetTime":1417912139,"moonPhase":0.52,"precipIntensity":0.0047,"precipIntensityMax":0.0069,"precipIntensityMaxTime":1417867200,"precipProbability":0.31,"precipType":"rain","temperatureMin":42.55,"temperatureMinTime":1417935600,"temperatureMax":52.24,"temperatureMaxTime":1417899600,"apparentTemperatureMin":42.55,"apparentTemperatureMinTime":1417935600,"apparentTemperatureMax":52.24,"apparentTemperatureMaxTime":1417899600,"dewPoint":43.98,"humidity":0.91,"windSpeed":2.67,"windBearing":143,"cloudCover":0.62,"pressure":1026.63,"ozone":310.15},{"time":1417939200,"summary":"Drizzle until afternoon.","icon":"rain","sunriseTime":1417966717,"sunsetTime":1417998529,"moonPhase":0.55,"precipIntensity":0.0037,"precipIntensityMax":0.006,"precipIntensityMaxTime":1417978800,"precipProbability":0.24,"precipType":"rain","temperatureMin":39.65,"temperatureMinTime":1417960800,"temperatureMax":52.38,"temperatureMaxTime":1417986000,"apparentTemperatureMin":38.33,"apparentTemperatureMinTime":1418022000,"apparentTemperatureMax":52.38,"apparentTemperatureMaxTime":1417986000,"dewPoint":41.19,"humidity":0.87,"windSpeed":3.02,"windBearing":106,"cloudCover":0.49,"pressure":1027.26,"ozone":308.04}]},"alerts":[{"title":"Wind Advisory for Multnomah, OR","time":1417351260,"expires":1417435200,"description":"...WIND ADVISORY REMAINS IN EFFECT UNTIL 4 AM PST MONDAY FOR THE\nGREATER PORTLAND AND VANCOUVER METRO AREA...\n* WINDS: EAST WINDS 25 TO 35 MPH WITH GUSTS 40 TO 50 MPH. THE\nSTRONGEST WINDS WILL BE NEAR THE COLUMBIA RIVER GORGE.\n* TIMING: WINDS WILL PICK UP THIS MORNING...PEAKING THIS AFTERNOON\nAND EARLY THIS EVENING AND THEN EASING EARLY MONDAY MORNING.\n* LOCATIONS INCLUDE: VANCOUVER...BATTLE GROUND...CAMAS...\nWASHOUGAL...HILLSBORO...PORTLAND...OREGON CITY...GRESHAM...\nTROUTDALE\n* IMPACTS: WINDS MAY CAUSE SOME TREE DAMAGE AND LOCAL POWER\nOUTAGES.\n","uri":"http://alerts.weather.gov/cap/wwacapget.php?x=OR125178E80B44.WindAdvisory.12517D235B00OR.PQRNPWPQR.95d9377231cf71049aacb48282406c60"},{"title":"Special Weather Statement for Multnomah, OR","time":1417342440,"expires":1417392000,"description":"...FREEZING RAIN POSSIBLE MONDAY MORNING...\nEAST WINDS AND A COOL AIRMASS WILL RESULT IN A CHILLY SUNDAY.\nDAYTIME TEMPERATURES WILL BARELY GET INTO THE 40S SOUTH OF\nSALEM...AND LIKELY REMAIN IN THE 30S TO THE NORTH. TEMPERATURES\nWILL DROP SUNDAY NIGHT UNDER MOSTLY CLEAR SKIES WITH WIDESPREAD\nTEMPERATURES NEAR OR BELOW FREEZING.\nA WARM FRONT WILL APPROACH FROM THE SOUTH LATE SUNDAY NIGHT AND\nBRING THE POTENTIAL FOR FREEZING RAIN TO THE WILLAMETTE VALLEY\nMONDAY MORNING. THERE IS A SLIGHT CHANCE FOR LIGHT FREEZING RAIN\nSOUTH OF MCMINNVILLE AFTER MIDNIGHT SUNDAY...WITH A BETTER CHANCE\nFOR VALLEY FREEZING RAIN NEAR SUNRISE MONDAY. THE SURFACE\nTEMPERATURES SHOULD WARM ABOVE FREEZING SHORTLY AFTER NOON.\nTHERE IS UNCERTAINTY ON THE TIMING OF THE WARMER AIR AND\nMOISTURE...AND ACCUMULATION AMOUNTS. THERE IS A CHANCE THAT THE\nTEMPERATURES WILL WARM ABOVE FREEZING BEFORE THE MOISTURE MOVES\nIN....BUT IF IT DOESN`T...THERE IS POTENTIAL FOR 0.10 TO 0.20 INCH\nOF ICE ACCUMULATION LATE SUNDAY NIGHT THROUGH MONDAY MORNING\nANYWHERE IN THE WILLAMETTE VALLEY...WITH MOST ACCUMULATIONS\nEXPECTED ON ELEVATED SURFACES.\nTHIS WOULD RESULT IN VERY HAZARDOUS DRIVING CONDITIONS AND\nPOSSIBLY CAUSE POWER OUTAGES. PLEASE MONITOR THE LATEST FORECAST\nAS THE DETAILS OF THIS EVENT WILL CHANGE THROUGHOUT THE THE\nWEEKEND.\n","uri":"http://alerts.weather.gov/cap/wwacapget.php?x=OR125178E7B298.SpecialWeatherStatement.12517D218640OR.PQRSPSPQR.53656f1fdba795381a7895d7e3d153f7"}],"flags":{"sources":["nwspa","isd","nearest-precip","sref","darksky","fnmoc","rtma","rap","nam","cmc","gfs","madis","lamp"],"isd-stations":["726980-24229","727918-94298","727918-99999","999999-24229","999999-24274"],"darksky-stations":["KRTX"],"madis-stations":["AU774","C7021","D3557","D3762","D4360","D7321","D9191","D9370","E1617","E1914","E2024","E2298","E4831","OD103","ODT10","ODT12"],"lamp-stations":["KHIO","KMMV","KPDX","KSPB","KTTD","KUAO","KVUO"],"units":"us"}}' }

    registry.configure do |config|
      config.handlers.forecast_io.api_uri = 'https://api.forecast.io/forecast/'
      config.handlers.forecast_io.api_key = '5537a6b7a8e2936dc7ced091b999d60a'
    end
  end

  # Todo: mock weather data for predictable output.

  it { is_expected.to route('!rain') }
  it { is_expected.to route('!ansirain') }
  it { is_expected.to route('!ansitemp') }
  it { is_expected.to route('!ansiwind') }
  it { is_expected.to route('!ansisun') }
  it { is_expected.to route('!ansicloud') }
  it { is_expected.to route('!7day') }
  it { is_expected.to route('!alerts') }

  it '!rain' do
    allow(MagicEightball).to receive(:reply) { 'Nope' }
    send_message '!rain Portland'
    expect(replies.last).to include('Nope')
  end

  it '!ansirain Paris' do
    send_message '!ansirain Paris'
    expect(replies.last).to include("|\u000302_▁\u000306▃\u000310▅\u000303▅\u000309▅\u000311▇\u000308▇\u000307█\u000304█\u000313█\u000302__________________________________________________\u0003|")
  end

  it '!ansitemp portland' do
    send_message '!ansitemp portland'
    expect(replies.last).to include('temps: now')
  end

  it '!ansiwind portland' do
    send_message '!ansiwind portland'
    expect(replies.last).to include("|\u000306←\u000310←←\u000311←←←\u000308←←\u000311←←←←←←←\u000310←←←←←←←\u000306←\u0003|")
  end

  it '!conditions' do
    send_message '!conditions'
    expect(replies.last).to include("Portland, OR 28.3°F |\u000306_▁▃\u000310▅▇█\u000303█\u0003| 38.72°F / 4.3 mph |\u000306←\u000310←←\u000311←←←\u000308←\u0003| 12.71 mph / 98% chance of sun / 60m rain |\u0003▁▃▅▅▅▇▇███_____________|")
  end

  it '!alerts' do
    send_message '!alerts'
    expect(replies.last).to eq("http://alerts.weather.gov/cap/wwacapget.php?x=OR125178E80B44.WindAdvisory.12517D235B00OR.PQRNPWPQR.95d9377231cf71049aacb48282406c60\nhttp://alerts.weather.gov/cap/wwacapget.php?x=OR125178E7B298.SpecialWeatherStatement.12517D218640OR.PQRSPSPQR.53656f1fdba795381a7895d7e3d153f7\n")
  end

  it '!ansisun' do
    send_message '!ansisun'
    expect(replies.last).to eq("Portland, OR 8 day sun forecast |\u000308█\u000309▃\u000308▇\u000309▁_\u000307▅\u000309▃\u000307▅\u0003|")
  end

  it '!ansicloud' do
    send_message '!ansicloud'
    expect(replies.last).to eq('Portland, OR 24h cloud cover |___________▁▁▁▁▁▁▁▁▃▅▅▅|')
  end

  it '!7day' do
    send_message '!7day'
    expect(replies.last).to eq("Portland, OR 7day high/low temps 39.0°F |\u000303_▃\u000309▅\u000303▅\u000309▅███\u0003| 52.4°F / 28.2°F |\u000306_▁▃\u000310▅\u000303█\u000310▇\u000303██\u0003| 39.7°F Range: 28.17°F - 52.38°F")
  end

  # it 'colors strings' do
    # cstr = Lita::Handlers::ForecastIo.get_colored_string([{:key => 1}], :key, 'x', {1 => :blue})
    # expect(cstr).to equal('x')
  # end
end
